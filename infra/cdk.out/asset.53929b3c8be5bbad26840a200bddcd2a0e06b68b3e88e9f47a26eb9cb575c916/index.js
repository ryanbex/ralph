"use strict";var E=Object.create;var c=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var h=(e,o)=>{for(var n in o)c(e,n,{get:o[n],enumerable:!0})},m=(e,o,n,s)=>{if(o&&typeof o=="object"||typeof o=="function")for(let t of y(o))!O.call(e,t)&&t!==n&&c(e,t,{get:()=>o[t],enumerable:!(s=N(o,t))||s.enumerable});return e};var I=(e,o,n)=>(n=e!=null?E(D(e)):{},m(o||!e||!e.__esModule?c(n,"default",{value:e,enumerable:!0}):n,e)),T=e=>m(c({},"__esModule",{value:!0}),e);var W={};h(W,{handler:()=>G});module.exports=T(W);var g=require("@aws-sdk/client-dynamodb"),r=require("@aws-sdk/lib-dynamodb"),a=require("@aws-sdk/client-apigatewaymanagementapi"),d=I(require("zlib")),k=new g.DynamoDBClient({}),u=r.DynamoDBDocumentClient.from(k),p=process.env.CONNECTIONS_TABLE,L=process.env.WEBSOCKET_ENDPOINT;function B(e){let o=e.split("/");return o.length>=2&&o[0]==="worker"?o[1]:null}async function $(e){try{return((await u.send(new r.QueryCommand({TableName:p,IndexName:"workstream-index",KeyConditionExpression:"workstreamId = :wsId",ExpressionAttributeValues:{":wsId":e}}))).Items||[]).map(n=>n.connectionId)}catch(o){return console.error("[QUERY] Error fetching connections:",o),[]}}async function x(e,o,n){try{return await e.send(new a.PostToConnectionCommand({ConnectionId:o,Data:Buffer.from(JSON.stringify(n))})),!0}catch(s){return s instanceof a.GoneException?(console.log(`[SEND] Stale connection ${o}, removing`),await u.send(new r.DeleteCommand({TableName:p,Key:{connectionId:o}}))):console.error(`[SEND] Error sending to ${o}:`,s),!1}}var G=async e=>{let o=Buffer.from(e.awslogs.data,"base64"),n=d.gunzipSync(o),s=JSON.parse(n.toString("utf-8"));console.log(`[LOGS] Received ${s.logEvents.length} log events from ${s.logStream}`);let t=B(s.logStream);if(!t){console.log("[LOGS] Could not extract workstream ID, skipping");return}let i=await $(t);if(i.length===0){console.log(`[LOGS] No connections for workstream ${t}`);return}console.log(`[LOGS] Broadcasting to ${i.length} connections for workstream ${t}`);let f=new a.ApiGatewayManagementApiClient({endpoint:L}),C=s.logEvents.map(l=>({timestamp:l.timestamp,message:l.message,workstreamId:t,logStream:s.logStream})),w=i.map(l=>x(f,l,{type:"logs",workstreamId:t,logs:C})),S=(await Promise.all(w)).filter(Boolean).length;console.log(`[LOGS] Sent to ${S}/${i.length} connections`)};0&&(module.exports={handler});
